<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>야나두 프로필</title>

    <!-- 부트스트랩 가져오기 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- JQuery 가져오기 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap');

        * {
            font-family: "Nanum Gothic", sans-serif;
            font-weight: 400;
            font-style: normal;
            color: #020715;
        }

        body {
            background-color: #FBFBFA;
        }

        .p-3 {
            background-color: #7582F4;
        }

        /* 야나두 로고 스타일 */
        #logo {
            font-weight: bold;
            cursor: pointer;
            background-color: transparent;
            border: none;
            text-align: left;
            font-size: 35px;
            color: #79B96E;
            z-index: 1;
            margin-bottom: 0px;
            margin-right: 20px;
        }

        #subtext {
            font-size: 17px;
            font-weight: normal;
            color: #79B96E;
        }

        #logo:hover {
            transform: translateY(-2px);
        }

        .myimfor {
            width: 1000px;
            margin: auto;
        }

        .myimfor-box {
            background-color: #79B96E;
            width: 300px;
            height: 320px;
            margin: 30px 50px 30px 120px;
            border-radius: 10px;
            padding: 20px;
            float: left;
        }

        .myimfor-box-label {
            font-size: 18px;
            font-weight: bold;
            float: left;
        }

        .myimfor-box-text {
            background-color: #FBFBFA;
            border-radius: 2px;
            margin-left: 70px;
            text-align: center;
        }

        .myintroduce {
            display: block;
            width: 800px;
            height: 200px;
            padding: 20px;
            margin-right: auto;
            margin-left: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            border: 2px solid #79B96E;
            overflow: auto;
        }

        .myintroduce-change {
            width: 800px;
            height: 240px;
            margin: auto;
            margin-bottom: 30px;
            padding: 20px;
            display: none;
            border-radius: 10px;
            border: 2px solid #79B96E;
        }

        .mypostlist {
            width: 1000px;
            height: 400px;
            margin: auto;
            margin-bottom: 50px;
            border-radius: 10px;
            border: 2px solid #79B96E;
        }

        .mypostlist-box {
            background-color: #79B96E;
            width: 300px;
            height: 320px;
            margin: 20px 50px auto 120px;
            border-radius: 10px;
            padding: 20px;
            float: left;
            overflow: auto;
        }

        .mypostlist-box-list {
            border-bottom: solid 2px #020715;
            margin-bottom: 10px;
            padding: 5px;
        }

        .textheader {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            background-color: #FBFBFA;
            border-radius: 2px;
        }

        .changebtn {
            background-color: #F7819F;
            border-radius: 2px;
            float: right;
            font-size: 13px;
        }
    </style>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js';
        import { getDatabase, ref, child, get, set, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

        // Firebase 구성
        const firebaseConfig = {
            apiKey: "AIzaSyBy-5HWDgxJ6hZ5h30Is7xCAZm3W7HmR78",
            authDomain: "yanado-a4df1.firebaseapp.com",
            databaseURL: "https://yanado-a4df1-default-rtdb.firebaseio.com",
            projectId: "yanado-a4df1",
            storageBucket: "yanado-a4df1.appspot.com",
            messagingSenderId: "1082911983171",
            appId: "1:1082911983171:web:f8843a3015379b859236f6",
            measurementId: "G-YKDTZ5B6Z7"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase();

        const id = 'oplk123'; // 일단 직접 lol 선언하고, 후에 메인페이지에서 받아오기
        const userRef = ref(db, 'users/' + id + '/' + id);

        // DB(users 테이블)에서 프로필 정보(이름, 나이, 성별, 지역) 가져오기
        get(userRef).then((usersnapshot) => {
            if (usersnapshot.exists()) {
                const userData = usersnapshot.val();
                if (userData.id == id) {
                    let temp_html_name = `${userData.name}`;
                    let temp_html_age = `${userData.age}`;
                    let temp_html_gender = `${userData.gender}`;
                    let temp_html_region = `${userData.region}`;
                    $('#imfor-name').empty().append(temp_html_name);
                    $('#imfor-age').empty().append(temp_html_age);
                    $('#imfor-gender').empty().append(temp_html_gender);
                    $('#imfor-region').empty().append(temp_html_region);
                } else {
                    alert('해당 아이디가 없습니다.');
                }
            } else {
                alert('데이터 검색에 실패했습니다.');
            }
        }).catch((error) => {
            console.error('Error getting user data: ', error);
        });

        // DB(users 테이블)에서 프로필 사진, 자기소개 가져오기
        get(userRef).then((usersnapshot) => {
            if (usersnapshot.exists()) {
                const userData = usersnapshot.val();
                if (userData.profileimage == "" && userData.introduce == "") {
                    alert('"프로필 사진"과 "자기소개"를 각각의 수정 버튼을 통해 설정해주세요.');
                } else if (userData.profileimage == "" && userData.introduce != "") { // 프사 x, 자기소개 o
                    let temp_html_intro = `<div>${userData.introduce}</div>`;
                    $('#introduce').empty().append(temp_html_intro);
                    alert('"프로필 사진"을 수정 버튼을 통해 설정해주세요.');
                } else if (userData.introduce == "" && userData.profileimage != "") { // 프사 o, 자기소개 x
                    let temp_html_image = `<img src="${userData.profileimage}" style="margin-top: 10px; text-align: center; border-radius: 50%; width: 250px; height: 250px;"/>`;
                    $('#profileimage').empty().append(temp_html_image);
                    alert('"자기소개"를 수정 버튼을 통해 설정해주세요.');
                } else { // 프사 o, 자기소개 o
                    let temp_html_image = `<img src="${userData.profileimage}" style="margin-top: 10px; text-align: center; border-radius: 50%; width: 250px; height: 250px;"/>`;
                    let temp_html_intro = `<div>${userData.introduce}</div>`;
                    $('#profileimage').empty().append(temp_html_image);
                    $('#introduce').empty().append(temp_html_intro);
                }
            }
        }).catch((error) => {
            console.error('Error getting user data: ', error);
        });

        // 버튼으로 프로필 사진 수정하기
        $("#imagechangebtn").click(async function () {
            let profileimageinput = prompt("프로필 이미지 주소를 정확히 입력해주세요.");
            if (profileimageinput == null || profileimageinput == "") {
                alert('프로필 이미지 수정이 취소되었습니다. "취소"를 누르셨거나 잘못된 값을 입력했습니다.')
            } else {
                const imagechangeRef = ref(db, 'users/' + id);
                const imagechangesnapshot = await get(child(imagechangeRef, id));
                const imagechangeData = imagechangesnapshot.val();
                const changeprofileimage = {
                    age: imagechangeData.age,
                    gender: imagechangeData.gender,
                    id: imagechangeData.id,
                    introduce: imagechangeData.introduce,
                    name: imagechangeData.name,
                    password: imagechangeData.password,
                    profileimage: profileimageinput, //프로필 사진만 업데이트, 나머지는 그대로
                    region: imagechangeData.region
                };
                const profileimage_updates = {};
                profileimage_updates['users/' + id + '/' + id] = changeprofileimage;
                update(ref(db), profileimage_updates); // DB에 프로필 사진 업데이트
                let temp_html_image_change = `<img src="${profileimageinput}" style="margin-top: 10px; text-align: center; border-radius: 50%; width: 250px; height: 250px;"/>`;
                $('#profileimage').empty().append(temp_html_image_change); // 웹페이지에 프로필 사진 수정
                alert('프로필 사진 변경 완료!');
            }
        });

        //자기소개 수정도구 토글
        $("#textchangebtn").click(async function () {
            $('#introduce-change').toggle();
        });

        // 자기소개 수정도구 저장하기 버튼
        $("#savebtn").click(async function () {
            let introducechange = document.getElementById("introduce-input").value;
            if (introducechange == null || introducechange == " ") {
                alert('잘못된 입력이거나 공백만 있는 입력입니다.');
            } else {
                const introducechangeRef = ref(db, 'users/' + id);
                const introducechangesnapshot = await get(child(introducechangeRef, id));
                const introducechangeData = introducechangesnapshot.val();
                const changeprofileintroduce = {
                    age: introducechangeData.age,
                    gender: introducechangeData.gender,
                    id: introducechangeData.id,
                    introduce: introducechange, //자기소개만 업데이트, 나머지는 그대로
                    name: introducechangeData.name,
                    password: introducechangeData.password,
                    profileimage: introducechangeData.profileimage,
                    region: introducechangeData.region
                };
                const introduce_updates = {};
                introduce_updates['users/' + id + '/' + id] = changeprofileintroduce;
                update(ref(db), introduce_updates); // DB에 프로필 자기소개 업데이트
                let temp_html_text = `<div>${introducechange}</div>`;
                $('#introduce').empty().append(temp_html_text);
                $(function () { //저장 후 textarea 초기화
                    $('#inputform')[0].reset();
                });
                alert('자기소개 수정 완료!');
                $('#introduce-change').toggle();
            }
        });
    </script>
</head>

<body>
    <header class="p-3 text-bg-dark"> <!-- 헤더 로그인 후 -->
        <div class="container">
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a href="main.html" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                    <div id="logo">야나두 <span id="subtext">너도 할 수 있어</span></div>
                </a>

                <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                    <li><a href="#" class="nav-link px-2" style="color: #020715;">계획전시</a></li>
                    <li><a href="#" class="nav-link px-2" style="color: #020715;">파티모집</a></li>
                </ul>

                <div class="text-end">
                    <button type="button" class="btn" style="color: #020715; background-color: #79B96E;"
                        onClick="location.href='profile.html'">내 프로필 보기</button>
                    <button type="button" class="btn" style="color: #020715; background-color: #F7819F;">로그아웃</button>
                </div>
            </div>
        </div>
    </header>

    <div>
        배너
    </div>

    <div class="myimfor">
        <div class="myimfor-box"> <!-- 프로필 사진 -->
            <h4 class="textheader">프로필 사진<button class="changebtn" id="imagechangebtn">수정</button></h4>
            <div id="profileimage"> <!-- JS에서 보낸 HTMl 이미지 태그 자리 --> </div>
        </div>
        <div class="myimfor-box"> <!-- 내 정보 -->
            <h4 class="textheader">내 정보</h4>
            <div style="margin-top: 30px;"><label class="myimfor-box-label">이름 :</label>
                <div class="myimfor-box-text" id="imfor-name"><span style="color: gray;">홍길동</span></div>
            </div>
            <div style="margin-top: 30px;"><label class="myimfor-box-label">나이 :</label>
                <div class="myimfor-box-text" id="imfor-age"><span style="color: gray;">20</span></div>
            </div>
            <div style="margin-top: 30px;"><label class="myimfor-box-label">성별 :</label>
                <div class="myimfor-box-text" id="imfor-gender"><span style="color: gray;">남</span></div>
            </div>
            <div style="margin-top: 30px;"><label class="myimfor-box-label">지역 :</label>
                <div class="myimfor-box-text" id="imfor-region"><span style="color: gray;">서울</span></div>
            </div>
        </div>
    </div>

    <div class="myintroduce" style="clear: both;"> <!-- 소개글 -->
        <h4 class="textheader" style="background-color: #79B96E;">자기소개
            <button class="changebtn" id="textchangebtn">수정 도구 펼치기/접기</button>
        </h4>
        <div id="introduce"><span style="color: gray;">자기소개 수정 도구를 펼쳐 자기소개를 입력해주세요.</span></div>
    </div>
    <div class="myintroduce-change" id="introduce-change"> <!-- 소개 수정 도구 -->
        <span class="input-group-text" style="background-color: #79B96E;">아래 칸에 수정할 내용을 입력하세요.</span>
        <form id="inputform">
            <textarea class="form-control" id="introduce-input" aria-label="With textarea" style="height: 120px;"
                placeholder="내용을 입력하세요"></textarea>
            <button type="button" class="changebtn" id="savebtn" style="margin-top: 20px;">저장하기</button>
            <button type="reset" class="changebtn"
                style="background-color: #7582F4; margin-top: 20px; margin-right: 10px;">초기화</button>
        </form>
    </div>

    <div class="mypostlist"> <!-- 내글 목록 -->
        <h3 class="textheader" style="background-color: #79B96E; font-size: 22px;">내 글 목록</h4>
            <div class="mypostlist-box">
                <h4 class="textheader">계획전시</h4>
                <div class="mypostlist-box-list">계획1</div>
                <div class="mypostlist-box-list">계획2</div>
                <div class="mypostlist-box-list">계획3</div>
            </div>
            <div class="mypostlist-box">
                <h4 class="textheader">파티모집</h4>
                <div class="mypostlist-box-list">파티1</div>
                <div class="mypostlist-box-list">파티2</div>
                <div class="mypostlist-box-list">파티3</div>
            </div>
    </div>

</body>

</html>